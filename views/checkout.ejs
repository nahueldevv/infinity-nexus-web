<%- include('partials/head', { title: 'Finalizar Compra' }) %>
  <%- include('partials/nav') %>

    <main class="bg-gray-50 dark:bg-dark-bg min-h-screen pt-32 pb-24">
      <div class="container mx-auto px-6 max-w-4xl">

        <div class="bg-white dark:bg-dark-card rounded-2xl shadow-2xl overflow-hidden">
          <div class="p-8 md:p-12">
            <div class="text-center mb-10">
              <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-100">Finalizar Compra</h1>
              <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">Estás a un paso de potenciar tu empresa.</p>
            </div>

            <div class="space-y-12">

              <div>
                <button id="summary-toggle"
                  class="flex justify-between items-center w-full pb-4 border-b dark:border-gray-700">
                  <span class="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-3">
                    <ion-icon name="receipt-outline"></ion-icon>
                    Ver resumen del pedido
                  </span>
                  <div class="flex items-center gap-4">
                    <span id="summary-total-header" class="font-bold text-lg text-infinity-blue">$0.00</span>
                    <ion-icon id="summary-chevron" name="chevron-down-outline"
                      class="w-6 h-6 transition-transform"></ion-icon>
                  </div>
                </button>
                <div id="summary-content" class="hidden mt-6 space-y-4 pr-2">
                </div>
              </div>

              <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-3 mb-4"><ion-icon
                    name="business-outline"></ion-icon>Datos de Envío y Facturación</h2>
                <div
                  class="bg-gray-100 dark:bg-dark-bg/50 p-6 rounded-xl border dark:border-gray-200 dark:border-gray-700/50 flex justify-between items-start">
                  <div>
                    <p class="font-bold text-gray-800 dark:text-gray-200">Tech Solutions SRL</p>
                    <p class="text-gray-600 dark:text-gray-400">Av. Siempre Viva 742, C1425, Buenos Aires</p>
                    <p class="text-sm text-gray-500">CUIT: 30-12345678-9</p>
                  </div>
                  <button class="font-semibold text-sm text-infinity-blue hover:underline">Editar</button>
                </div>
              </div>

              <div>
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 flex items-center gap-3 mb-4"><ion-icon
                    name="card-outline"></ion-icon>Información de Pago</h2>
                <div class="space-y-5">
                  <div class="relative">
                    <ion-icon name="person-outline" class="form-icon"></ion-icon>
                    <label for="card-name" class="form-label mr-4">Nombre en la tarjeta</label>
                    <input type="text" id="card-name" placeholder="Juan Pérez"
                      class="form-input p-2 rounded-md text-gray-800">
                  </div>
                  <div class="relative">
                    <ion-icon name="card-outline" class="form-icon"></ion-icon>
                    <label for="card-number" class="form-label mr-4">Número de la tarjeta</label>
                    <input type="text" id="card-number" placeholder="49•• •••• •••• ••••"
                      class="form-input p-2 rounded-md text-gray-800">
                  </div>
                  <div class="flex items-center gap-5">
                    <div class="relative">
                      <ion-icon name="calendar-outline" class="form-icon"></ion-icon>
                      <label for="card-expiry" class="form-label mr-4">Vencimiento</label>
                      <input type="text" id="card-expiry" placeholder="MM / YY"
                        class="form-input p-2 rounded-md text-gray-800">
                    </div>
                    <div class="relative">
                      <ion-icon name="lock-closed-outline" class="form-icon"></ion-icon>
                      <label for="card-cvc" class="form-label mr-4">CVC</label>
                      <input type="text" id="card-cvc" placeholder="•••"
                        class="form-input p-2 rounded-md text-gray-800">
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-center pt-6 border-t dark:border-gray-700">
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">O paga con una de nuestras otras opciones:</p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                  <button type="button" class="alt-payment-btn flex items-center gap-2"><img src="/images/mplogo.webp"
                      alt="Logo de Mercado Pago" class="w-7 h-7 invert-0 dark:invert transition-all duration-300"><span
                      class="hover:text-infinity-cyan transition-colors">Mercado
                      Pago</span></button>
                  <button type="button" class="alt-payment-btn flex items-center gap-2"><ion-icon name="wallet-outline"
                      class="w-6 h-6"></ion-icon><span class="hover:text-infinity-cyan transition-colors">Transferencia
                      Bancaria</span></button>
                </div>
              </div>

              <div class="mt-10 pt-8 border-t dark:border-gray-700">
                <label class="flex items-center gap-3">
                  <input type="checkbox" id="terms-checkbox"
                    class="h-5 w-5 rounded border-gray-300 text-infinity-blue focus:ring-infinity-blue">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Acepto los <a href="#"
                      class="font-semibold underline hover:text-infinity-blue">Términos y Condiciones</a>.</p>
                </label>
                <form id="checkout-form">
                  <button type="submit" id="pay-button" disabled
                    class="mt-6 w-full bg-gradient-to-r from-infinity-blue to-infinity-purple text-white font-bold py-4 rounded-lg text-xl flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>Pagar Ahora</span>
                    <span id="final-total-button" class="font-normal">$0.00</span>
                  </button>
                </form>
              </div>

            </div>
          </div>
        </div>
      </div>
    </main>

    <div id="payment-overlay" class="fixed inset-0 bg-black/70 z-[100] hidden items-center justify-center flex-col">
      <div class="w-16 h-16 border-4 border-white border-t-infinity-cyan rounded-full animate-spin"></div>
      <p class="text-white text-xl mt-6 font-semibold">Procesando pago...</p>
    </div>

    <style>
      .form-label {
        @apply absolute bg-white dark:bg-dark-card px-1 text-xs font-medium text-gray-500 dark:text-gray-400 -top-2 left-3;
      }

      .form-input {
        @apply block w-full rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-transparent py-3 px-4 pl-12 shadow-sm focus:border-infinity-blue focus:ring-0;
      }

      .form-icon {
        @apply absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl;
      }

      .alt-payment-btn {
        @apply flex-1 flex items-center justify-center gap-3 py-3 px-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg font-semibold text-gray-700 dark:text-gray-300 hover:border-infinity-blue hover:bg-infinity-blue/10 transition-all;
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Selectores de Elementos
        const summaryToggle = document.getElementById('summary-toggle');
        const summaryContent = document.getElementById('summary-content');
        const summaryChevron = document.getElementById('summary-chevron');
        const summaryTotalHeader = document.getElementById('summary-total-header');
        const finalTotalButton = document.getElementById('final-total-button');
        const payButton = document.getElementById('pay-button');
        const termsCheckbox = document.getElementById('terms-checkbox');
        const paymentOverlay = document.getElementById('payment-overlay');

        const cart = JSON.parse(localStorage.getItem('infinityNexusCart')) || [];

        // Lógica para el resumen colapsable
        summaryToggle.addEventListener('click', () => {
          summaryContent.classList.toggle('hidden');
          summaryChevron.classList.toggle('rotate-180');
        });

        // Función para renderizar el resumen del pedido
        const renderSummary = () => {
          summaryContent.innerHTML = '';
          if (cart.length === 0) {
            summaryContent.innerHTML = '<p class="text-gray-500">Tu carrito está vacío.</p>';
            window.location.href = '/tienda';
            return;
          }
          let subtotal = 0;
          cart.forEach(item => {
            const itemHtml = `
                <div class="flex items-center gap-4 text-sm border-b dark:border-gray-800 pb-4">
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 rounded-lg">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800 dark:text-gray-200">${item.name}</p>
                        <p class="text-gray-500">Cantidad: ${item.quantity}</p>
                    </div>
                    <p class="font-semibold text-gray-900 dark:text-gray-200">$${(item.price * item.quantity).toFixed(2)}</p>
                </div>`;
            summaryContent.innerHTML += itemHtml;
            subtotal += item.price * item.quantity;
          });
          const totalText = `$${subtotal.toFixed(2)}`;
          summaryTotalHeader.textContent = totalText;
          finalTotalButton.textContent = totalText;
        };

        // Habilitar/deshabilitar el botón de pago
        termsCheckbox.addEventListener('change', () => {
          payButton.disabled = !termsCheckbox.checked;
        });

        // Envío del formulario
        document.getElementById('checkout-form').addEventListener('submit', (e) => {
          e.preventDefault();
          if (termsCheckbox.checked) {
            paymentOverlay.classList.remove('hidden');
            paymentOverlay.classList.add('flex');

            setTimeout(() => {
              localStorage.removeItem('infinityNexusCart');
              window.location.href = '/gracias';
            }, 3000);
          }
        });

        // Carga inicial
        renderSummary();
        payButton.disabled = !termsCheckbox.checked;
      });
    </script>

    <%- include('partials/footer') %>